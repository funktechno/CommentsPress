name: FTP Deploy

# Cancel in-progress workflows when a new workflow is created. Should only apply to PRs.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    # inputs:
    #   build_windows:
    #     description: "Build for Windows"
    #     required: true
    #     type: boolean
    #     default: true
    # tmp comment out after testing
  pull_request:
    branches: [master]

jobs:
  deploy:
    name: Deploy to FTP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare deploy package
        run: |
          set -euo pipefail
          echo "Preparing deploy directory..."
          rm -rf deploy || true
          mkdir -p deploy

          # Copy all .php files while preserving directory structure, but exclude the config folder
          # --prune-empty-dirs removes directories that would be empty after filtering  --dry-run
          rsync -av --prune-empty-dirs \
            --exclude='config' \
            --exclude='library/mailFunctions.php' \
            --exclude='tests' \
            --exclude='mail' \
            --include='*.php' \
            --include='*/' \
            --exclude='*' \
            ./ deploy/

          # rsync -av --prune-empty-dirs \
          #   --include='css/**' \
          #   --include='images/**' \
          #   --include='assets/**' \
          #   --include='examples/**' \
          #   --include='*/' \
          #   --exclude='*' \
          #   ./ deploy/

          # Ensure specific asset directories are included
          for d in assets css images examples; do
            if [ -d "$d" ]; then
              rsync -av "$d" deploy/"$d"/
            fi
          done

          echo "Deploy package contents:"
          find deploy -maxdepth 4 -type f | sed -n '1,200p'

      - name: Upload via SFTP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          source: "deploy/*"
          target: "/"
          debug: true

      # - name: Deploy to FTP server
      #   uses: SamKirkland/FTP-Deploy-Action@4.3.0
      #   with:
      #     server: ${{ secrets.FTP_SERVER }}
      #     username: ${{ secrets.FTP_USER }}
      #     password: ${{ secrets.FTP_PASSWORD }}
      #     port: ${{ secrets.FTP_PORT }}
      #     local-dir: deploy/
          # server-dir: /
          # ${{ secrets.FTP_REMOTE_DIR }}

    #   - name: Cleanup
    #     if: always()
    #     run: rm -rf deploy
